{% load static %}
<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teacher’s Assistant Sign Up</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['"Open Sauce Sans"', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial'],
          },
        },
      },
    }
  </script>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:FILL@0..1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="h-full bg-neutral-100 font-sans">
  {% include 'snippets/message/message.html' %}

  <main class="min-h-full flex items-center justify-center p-6">
    <section class="w-full max-w-2xl bg-white rounded-lg border border-neutral-200 shadow-sm">
      <div class="p-6">
        <h1 class="text-2xl font-semibold text-neutral-900">Create your Teacher’s Assistant account</h1>
        <p class="mt-1 text-sm text-neutral-600">Sign up with Google or use your email.</p>

        <button id="googleBtn" class="mt-4 w-full inline-flex items-center justify-center gap-2 rounded-md bg-neutral-900 text-white px-4 py-2 hover:bg-black transition-colors">
          <span class="material-symbols-outlined">login</span>
          <span>Sign up with Google</span>
        </button>

        <div class="flex items-center gap-4 my-6">
          <div class="h-px bg-neutral-200 flex-1"></div>
          <span class="text-xs text-neutral-500">Or</span>
          <div class="h-px bg-neutral-200 flex-1"></div>
        </div>

        <form id="taSignupForm" class="space-y-4" novalidate>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-neutral-700">First Name</label>
              <div class="mt-1 relative">
                <input id="firstName" type="text" class="w-full rounded-md border border-neutral-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-neutral-400" placeholder="Jane" required>
                <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-neutral-500">person</span>
              </div>
            </div>
            <div>
              <label class="text-sm text-neutral-700">Last Name</label>
              <div class="mt-1 relative">
                <input id="lastName" type="text" class="w-full rounded-md border border-neutral-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-neutral-400" placeholder="Doe" required>
                <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-neutral-500">person</span>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-neutral-700">Title</label>
              <div class="mt-1 relative">
                <select id="title" class="w-full rounded-md border border-neutral-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-neutral-400" required>
                  <option value="" disabled selected>Select</option>
                  <option>Mr</option>
                  <option>Mrs</option>
                  <option>Ms</option>
                </select>
                <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-neutral-500">expand_more</span>
              </div>
            </div>
            <div>
              <label class="text-sm text-neutral-700">Teacher’s Assistant Code</label>
              <div class="mt-1 relative">
                <input id="specialCode" type="text" class="w-full rounded-md border border-neutral-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-neutral-400" placeholder="e.g., TA-ABC123" required>
                <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-neutral-500">key</span>
              </div>
              <p id="codeHint" class="mt-1 text-xs text-neutral-500">Use the unique code provided by your Professor.</p>
            </div>
          </div>

          <div>
            <label class="text-sm text-neutral-700">Email</label>
            <div class="mt-1 relative">
              <input id="email" type="email" class="w-full rounded-md border border-neutral-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-neutral-400" placeholder="you@example.com" required>
              <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-neutral-500">mail</span>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-neutral-700">Password</label>
              <div class="mt-1 relative">
                <input id="password" type="password" class="w-full rounded-md border border-neutral-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-neutral-400" placeholder="********" required>
                <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-neutral-500">lock</span>
              </div>
            </div>
            <div>
              <label class="text-sm text-neutral-700">Rewrite Password</label>
              <div class="mt-1 relative">
                <input id="confirmPassword" type="password" class="w-full rounded-md border border-neutral-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-neutral-400" placeholder="********" required>
                <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-neutral-500">lock</span>
              </div>
            </div>
          </div>

          <ul id="passwordRules" class="mt-2 text-xs space-y-1 text-neutral-600">
            <li id="rule-length">• At least 8 characters</li>
            <li id="rule-upper">• At least 1 uppercase letter</li>
            <li id="rule-special">• At least 1 special character</li>
            <li id="rule-match">• Passwords match</li>
          </ul>

          <button id="signupBtn" class="mt-4 w-full rounded-md bg-neutral-900 text-white px-4 py-2.5 transition-colors hover:bg-black disabled:opacity-50 disabled:cursor-not-allowed hidden" disabled>
            Create Account
          </button>
          <div id="confirmHelp" class="mt-2 text-xs text-neutral-600 hidden">
            Didn’t receive the email?
            <button id="resendBtn" type="button" class="underline text-neutral-900">Resend confirmation</button>
          </div>

          <p class="mt-3 text-xs text-neutral-600">
            If your code is incorrect, you’ll see an error:
            “Please contact the Professor to give you their unique Teachers Assistant code!”
          </p>
        </form>

        <div class="mt-4 text-sm text-neutral-700">
          Already have an account?
          <a href="{% url 'teachers_assistants_login' %}" class="underline text-neutral-900">Log in</a>
        </div>
      </div>
    </section>
  </main>

  <script>
    const supabaseUrl = window.SUPABASE_URL || '{{ SUPABASE_URL|default:"" }}';
    const supabaseKey = window.SUPABASE_ANON_KEY || '{{ SUPABASE_ANON_KEY|default:"" }}';
    const sb = (supabaseUrl && supabaseKey && window.supabase?.createClient)
      ? window.supabase.createClient(supabaseUrl, supabaseKey, { auth: { persistSession: true, autoRefreshToken: true } })
      : null;

    const REDIRECT_URL = "{{ request.scheme }}://{{ request.get_host }}{% url 'teachers_assistants_signup' %}";
    let didConfirmRedirect = false;

    const firstNameEl = document.getElementById('firstName');
    const lastNameEl = document.getElementById('lastName');
    const titleEl = document.getElementById('title');
    const specialCodeEl = document.getElementById('specialCode');
    const emailEl = document.getElementById('email');
    const passwordEl = document.getElementById('password');
    const confirmEl = document.getElementById('confirmPassword');
    const signupBtn = document.getElementById('signupBtn');
    const googleBtn = document.getElementById('googleBtn');
    const confirmHelp = document.getElementById('confirmHelp');
    const resendBtn = document.getElementById('resendBtn');
    const codeHintEl = document.getElementById('codeHint');

    const ruleEls = {
      length: document.getElementById('rule-length'),
      upper: document.getElementById('rule-upper'),
      special: document.getElementById('rule-special'),
      match: document.getElementById('rule-match'),
    };

    function setRuleClass(el, ok) {
      el.classList.remove('text-neutral-600', 'text-red-600', 'text-green-600');
      el.classList.add(ok ? 'text-green-600' : 'text-red-600');
    }
    function emailValid() { return emailEl.validity.valid; }
    function allRequiredFilled() {
      return (
        firstNameEl.value.trim() &&
        lastNameEl.value.trim() &&
        titleEl.value.trim() &&
        specialCodeEl.value.trim() &&
        emailEl.value.trim() &&
        passwordEl.value &&
        confirmEl.value
      );
    }
    function checkPasswordRules(pw, confirmPw) {
      return {
        length: pw.length >= 8,
        upper: /[A-Z]/.test(pw),
        special: /[!@#$%^&*()_\-+={}[\]|:;"'<>,.?/~`]/.test(pw),
        match: pw.length > 0 && pw === confirmPw,
      };
    }
    function updatePasswordUI() {
      const pw = passwordEl.value;
      const cpw = confirmEl.value;
      const res = checkPasswordRules(pw, cpw);
      setRuleClass(ruleEls.length, res.length);
      setRuleClass(ruleEls.upper, res.upper);
      setRuleClass(ruleEls.special, res.special);
      setRuleClass(ruleEls.match, res.match);
    }
    function updateFormValidity() {
      updatePasswordUI();
      const pw = passwordEl.value;
      const cpw = confirmEl.value;
      const rules = checkPasswordRules(pw, cpw);
      const passOk = rules.length && rules.upper && rules.special && rules.match;
      const emailOk = emailValid();
      const filled = allRequiredFilled();
      const allOk = passOk && emailOk && filled;
      signupBtn.disabled = !allOk;
      signupBtn.classList.toggle('hidden', !allOk);
    }
    [firstNameEl, lastNameEl, titleEl, specialCodeEl, emailEl, passwordEl, confirmEl].forEach(el => el.addEventListener('input', updateFormValidity));
    updateFormValidity();

    async function announceAndRedirectIfConfirmed(sessionOrUser) {
      const user = sessionOrUser?.user || sessionOrUser || null;
      const uid = user?.id;
      const confirmedAt = user?.email_confirmed_at;
      if (!uid || !confirmedAt || didConfirmRedirect) return false;
      try {
        localStorage.setItem('ta_logged_in', '1');
        localStorage.setItem('ta_user_id', uid);
        localStorage.setItem('ta_email', user?.email || '');
      } catch (_) {}
      try {
        const res = await fetch('/assistants/confirm-signup/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ supabase_user_id: uid })
        });
        const json = await res.json();
        if (json?.ok && json?.confirmed) {
          if (typeof showMessage === 'function') {
            showMessage('Your email is confirmed. Redirecting to your dashboard…', 'success', 5000);
          }
          didConfirmRedirect = true;
          setTimeout(() => { window.location.href = '/dashboard/assistants/'; }, 800);
          return true;
        }
      } catch (_) {}
      return false;
    }

    (async () => {
      if (!sb) return;
      try {
        const { data: { session } } = await sb.auth.getSession();
        await announceAndRedirectIfConfirmed(session);
      } catch (_) {}
    })();

    if (sb?.auth?.onAuthStateChange) {
      sb.auth.onAuthStateChange(async (event, session) => {
        if (event === 'SIGNED_IN') {
          await announceAndRedirectIfConfirmed(session);
        }
      });
    }

    function resendConfirmation(email) {
      (async () => {
        try {
          const res = await fetch('/assistants/resend-confirmation/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });
          const json = await res.json();
          if (!json?.ok) throw new Error(json?.error || 'Resend failed.');
          if (json?.confirm_link) {
            if (typeof showMessage === 'function') {
              showMessage('Opening your confirmation link…', 'success', 6000);
            }
            window.location.href = json.confirm_link;
            return;
          }
          if (typeof showMessage === 'function') {
            showMessage(`Confirmation email resent to ${email}.`, 'success', 8000);
          }
        } catch (e) {
          const msg = e?.message || 'Resend failed.';
          if (typeof showMessage === 'function') showMessage(msg, 'error', 10000);
        }
      })();
    }

    googleBtn.addEventListener('click', async () => {
      if (!sb) {
        if (typeof showMessage === 'function') {
          showMessage('Supabase not configured: set SUPABASE_URL and SUPABASE_ANON_KEY.', 'error', 8000);
        }
        return;
      }
      try {
        await sb.auth.signInWithOAuth({
          provider: 'google',
          options: { redirectTo: REDIRECT_URL }
        });
      } catch (e) {
        const msg = e?.message || 'Google sign-in failed.';
        const hint = 'Hint: Check client ID/secret and redirect URI in Google Console.';
        if (typeof showMessage === 'function') showMessage(`${msg} ${hint}`, 'error', 10000);
      }
    });

    document.getElementById('taSignupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      updateFormValidity();

      const pw = passwordEl.value;
      const cpw = confirmEl.value;
      const rules = checkPasswordRules(pw, cpw);
      const reasons = [];
      if (!firstNameEl.value.trim()) reasons.push('First Name is required.');
      if (!lastNameEl.value.trim()) reasons.push('Last Name is required.');
      if (!titleEl.value.trim()) reasons.push('Title is required.');
      if (!specialCodeEl.value.trim()) reasons.push('Teacher’s Assistant Code is required.');
      if (!emailValid()) reasons.push('Enter a valid email address.');
      if (!rules.length) reasons.push('Password must be at least 8 characters.');
      if (!rules.upper) reasons.push('Password must include an uppercase letter.');
      if (!rules.special) reasons.push('Password must include a special character.');
      if (!rules.match) reasons.push('Passwords must match.');

      if (reasons.length) {
        if (typeof showMessage === 'function') showMessage(`Fix the following: ${reasons.join(' ')}`, 'error', 12000);
        return;
      }
      if (!sb) {
        if (typeof showMessage === 'function') {
          showMessage('Supabase not configured: set SUPABASE_URL and SUPABASE_ANON_KEY.', 'error', 8000);
        }
        return;
      }

      // 1) Validate TA code first
        try {
            const vres = await fetch('/assistants/validate-code/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ special_code: specialCodeEl.value.trim() })
            });
            const vjson = await vres.json();
            if (!vres.ok || !vjson?.ok) {
                codeHintEl.classList.remove('text-neutral-500', 'text-green-600');
                codeHintEl.classList.add('text-red-600');
                if (typeof showMessage === 'function') {
                    showMessage('Please contact the Professor to give you their unique Teachers Assistant code!', 'error', 12000);
                }
                return;
            }
            if (vjson.claimed) {
                codeHintEl.classList.remove('text-neutral-500', 'text-green-600');
                codeHintEl.classList.add('text-red-600');
                if (typeof showMessage === 'function') {
                    showMessage('This code is already assigned to someone else.', 'error', 12000);
                }
                return;
            }
            codeHintEl.classList.remove('text-neutral-500', 'text-red-600');
            codeHintEl.classList.add('text-green-600');
        } catch (_) {
            if (typeof showMessage === 'function') {
                showMessage('Unable to validate TA code. Try again.', 'error', 8000);
            }
            return;
        }

      signupBtn.disabled = true;
      signupBtn.textContent = 'Creating account...';

      try {
        const { data, error } = await sb.auth.signUp({
          email: emailEl.value.trim(),
          password: passwordEl.value,
          options: { emailRedirectTo: REDIRECT_URL }
        });
        if (error) throw error;

        const userId = data?.user?.id || null;

        // 2) Record TA in Django after successful signup
        if (userId) {
          const res = await fetch('/assistants/register/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              supabase_user_id: userId,
              first_name: firstNameEl.value.trim(),
              last_name: lastNameEl.value.trim(),
              title: titleEl.value.trim(),
              email: emailEl.value.trim(),
              special_code: specialCodeEl.value.trim()
            })
          });
          const json = await res.json();
          if (!json?.ok) {
            const msg = json?.error || 'Assistant registration failed.';
            if (typeof showMessage === 'function') showMessage(msg, 'error', 12000);
          } else {
            window.__assistantSignupEmail = emailEl.value.trim();
            window.__assistantSignupUserId = userId;
            confirmHelp.classList.remove('hidden');
            resendBtn.onclick = () => resendConfirmation(window.__assistantSignupEmail);

            if (json?.redirect_to) {
              if (typeof showMessage === 'function') {
                showMessage('Account created and confirmed. Redirecting…', 'success', 6000);
              }
              setTimeout(() => { window.location.href = json.redirect_to; }, 800);
            } else {
              if (typeof showMessage === 'function') {
                showMessage('Check your email to confirm your account.', 'success', 8000);
              }
            }
          }
        }

        signupBtn.disabled = false;
        signupBtn.textContent = 'Create Account';
      } catch (err) {
        const msg = err?.message || 'Unexpected error during signup.';
        const hint = 'Hint: Check network connectivity and server logs for details.';
        if (typeof showMessage === 'function') showMessage(`${msg} ${hint}`, 'error', 12000);
        signupBtn.disabled = false;
        signupBtn.textContent = 'Create Account';
      }
    });
  </script>
</body>
</html>